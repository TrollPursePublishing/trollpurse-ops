AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Parameters:
  BuildConfiguration:
    Type: String
    AllowedValues:
      - DockerRepositoryOnly
      - MassiveContainerBuilder
      - UnrealEngine4Support
    Description: What support systems should be bootstrapped? UnrealEngine4Support implies MassiveContainerBuilder and DockerRepositoryOnly. MassiveContainerBuilder implies DockerRepositoryOnly.
    ConstraintDescription: Only one of DockerRepositoryOnly, MassiveContainerBuilder, and UnrealEngine4Support.
  GithubPrivateAccessToken:
    Type: String
    Description: Needed to access repositories in CodePipeline, despite them being public.
    NoEcho: true
  UE4GithubUsername:
    Type: String
    Description: Only needed if UnrealEngine4Support is selected. The username that has access to EpicGames/UnrealEngine or forked repo on GitHub.
    Default: "N/A"
  UE4GithubPrivateAccessToken:
    Type: String
    Description: Only needed if UnrealEngine4Support is selected. The private access token needed to build the ue4 source container
    Default: "N/A"
    NoEcho: true
  CustomActionProviderName:
    Type: String
    Description: Name of the custom action provider.
    Default: WindowsLargeDockerBuilder
  CustomActionProviderVersion:
    Type: Number
    Description: Version of the custom action provider.
    Default: 1
Conditions:
  BuildUE4Stuff:
    !Equals [ !Ref BuildConfiguration, UnrealEngine4Support ]
  BuildWindowsContainerStuff:
    !Or [!Equals [ !Ref BuildConfiguration, MassiveContainerBuilder ], Condition: BuildUE4Stuff ]
  NeedsRolesAndArtifacts:
    !Not [!Equals [!Ref BuildConfiguration, DockerRepositoryOnly] ]
Resources:
  ArtifactStores:
    Type: AWS::CloudFormation::Stack
    Condition: NeedsRolesAndArtifacts
    Properties:
      TemplateURL: ../common/ops-storage.yml
  
  ContainerRepository:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ../common/ops-ecr.yml
      Parameters:
        RepositoryName: ue4-full
  
  PipelineRoles:
    Type: AWS::CloudFormation::Stack
    Condition: NeedsRolesAndArtifacts
    Properties:
      TemplateURL: ../common/ops-iam.yml
      Parameters:
        ArtifactStoreBucketArn: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketArn
        ClientDownloadBucketArn: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketArn
        CodeBuildImageEcrArn: !GetAtt ContainerRepository.Outputs.RepositoryArn
      
  MassiveContainerBuilder:
    Type: AWS::CloudFormation::Stack
    Condition: BuildWindowsContainerStuff
    Properties:
      TemplateURL: bootstrap-fat-container-build.yml
      Parameters:
        TemplateArtifactBucketName: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketName
        PackageArtifactBucketName: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketName
        PackageArtifactBucketArn: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketArn
        CodePipelineRoleArn: !GetAtt PipelineRoles.Outputs.CodePipelineServiceRoleArn
        CodeBuildRoleArn: !GetAtt PipelineRoles.Outputs.CodeBuildRoleArn
        GithubAccessToken: !Ref GithubPrivateAccessToken
        BuilderCustomerActionName: !Ref CustomActionProviderName
      
  UE4ContainerPipeline:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - MassiveContainerBuilder
    Condition: BuildUE4Stuff
    Properties:
      TemplateURL: ue4/bootstrap-ue4-container-build.yml
      Parameters:
        CodePipelineRoleArn: !GetAtt PipelineRoles.Outputs.CodePipelineServiceRoleArn
        CustomActionProviderName: !Ref CustomActionProviderName
        CustomActionProviderVersion: !Ref CustomActionProviderVersion
        DockerImageRepository: !GetAtt ContainerRepository.Outputs.RepositoryURI
        ArtifactBucketName: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketName
        UE4GithubUsername: !Ref UE4GithubUsername
        UE4GithubPrivateAccessToken: !Ref UE4GithubPrivateAccessToken
        GithubAccessToken: !Ref GithubPrivateAccessToken
