AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Parameters:
  BuildConfiguration:
    Type: String
    AllowedValues:
      - DockerRepositoryOnly
      - LargeContainerBuilder
      - UnrealEngine4Support
    Description: What support systems should be bootstrapped? UnrealEngine4Support implies LargeContainerBuilder and DockerRepositoryOnly. LargeContainerBuilder implies DockerRepositoryOnly.
    ConstraintDescription: Only one of DockerRepositoryOnly, LargeContainerBuilder, and UnrealEngine4Support.
  GithubPrivateAccessToken:
    Type: String
    Description: Needed to access repositories in CodePipeline, despite them being public.
    NoEcho: true
  UE4GithubUsername:
    Type: String
    Description: Only needed if UnrealEngine4Support is selected. The username that has access to EpicGames/UnrealEngine or forked repo on GitHub.
    Default: "N/A"
  UE4GithubPrivateAccessToken:
    Type: String
    Description: Only needed if UnrealEngine4Support is selected. The private access token needed to build the ue4 source container
    Default: "N/A"
    NoEcho: true
Conditions:
  BuildUE4Stuff:
    !Equals [ !Ref BuildConfiguration, UnrealEngine4Support ]
  BuildWindowsContainerStuff:
    !Or [!Equals [ !Ref BuildConfiguration, LargeContainerBuilder ], Condition: BuildUE4Stuff ]
  NeedsRolesAndArtifacts:
    !Not [!Equals [!Ref BuildConfiguration, DockerRepositoryOnly] ]
Resources:
  ArtifactStores:
    Type: AWS::CloudFormation::Stack
    Condition: NeedsRolesAndArtifacts
    Properties:
      TemplateURL: ../common/ops-storage.yml
  
  ContainerRepository:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ../common/ops-ecr.yml
  
  PipelineRoles:
    Type: AWS::CloudFormation::Stack
    Condition: NeedsRolesAndArtifacts
    Properties:
      TemplateURL: ../common/ops-iam.yml
      Parameters:
        ArtifactStoreBucketArn: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketArn
        ClientDownloadBucketArn: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketArn
        CodeBuildImageEcrArn: !GetAtt ContainerRepository.Outputs.RepositoryArn
      
  LargeContainerBuilder:
    Type: AWS::CloudFormation::Stack
    Condition: BuildWindowsContainerStuff
    Properties:
      TemplateURL: bootstrap-fat-container-build.yml
      Parameters:
        TemplateArtifactBucketName: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketName
        PackageArtifactBucketName: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketName
        PackageArtifactBucketArn: !GetAtt ArtifactStores.Outputs.ClientDownloadBucketArn
        CodePipelineRoleArn: !GetAtt PipelineRoles.Outputs.CodePipelineServiceRoleArn
        CodeBuildRoleArn: !GetAtt PipelineRoles.Outputs.CodeBuildRoleArn
        GithubAccessToken: !Ref GithubPrivateAccessToken
      
  UE4ContainerPipeline:
    Type: AWS::CloudFormation::Stack
    Condition: BuildUE4Stuff
    Properties:
      TemplateURL: ue4/bootstrap-ue4-container-build.yml
      Parameters:
        CodePipelineRoleArn: !GetAtt PipelineRoles.Outputs.CodePipelineServiceRoleArn
        CustomActionProviderName: !GetAtt LargeContainerBuilder.Outputs.FatContainerBuilderName
        CustomActionProviderVersion: "1"
        DockerImageRepository: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ContainerRepository.Outputs.RepositoryName}"
        ArtifactBucketName: !GetAtt ArtifactStores.Outputs.ArtifactStoreBucketName
        UE4GithubUsername: !Ref UE4GithubUsername
        UE4GithubPrivateAccessToken: !Ref UE4GithubPrivateAccessToken
        GithubAccessToken: !Ref GithubPrivateAccessToken
Outputs:
  DockerImageRepository:
    Description: Uri for ECR to be used for codebuild custom containers.
    Value: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ContainerRepository.Outputs.RepositoryName}"
    Export:
      Name: DockerImageRepository
  EcrArn:
    Description: Arn for repository containing custom build images meant for codebuild.
    Value: !GetAtt ContainerRepository.Outputs.RepositoryArn
    Export:
      Name: OpsEcrArn
